apiVersion: v1
kind: ReplicationController
metadata:
  name: monitoring-influxdb-grafana-v3
  namespace: kube-system
  labels:
    k8s-app: influxGrafana
    version: v3
    kubernetes.io/cluster-service: "true"
spec:
  replicas: 1
  selector:
    k8s-app: influxGrafana
    version: v3
  template:
    metadata:
      labels:
        k8s-app: influxGrafana
        version: v3
        kubernetes.io/cluster-service: "true"
    spec:
      containers:
        - image: gcr.io/google_containers/heapster_influxdb:v0.5
          name: influxdb
          resources:
            # keep request = limit to keep this container in guaranteed class
            limits:
              cpu: 100m
              memory: 500Mi
            requests:
              cpu: 100m
              memory: 500Mi
          ports:
            - containerPort: 8083
            - containerPort: 8086
          volumeMounts:
          - name: influxdb-persistent-storage
            mountPath: /data
        - image: gcr.io/google_containers/heapster_grafana:v2.6.0-2
          name: grafana
          env:
          resources:
            # keep request = limit to keep this container in guaranteed class
            limits:
              cpu: 100m
              memory: 100Mi
            requests:
              cpu: 100m
              memory: 100Mi
          env:
            # This variable is required to setup templates in Grafana.
            - name: INFLUXDB_SERVICE_URL
              value: http://monitoring-influxdb:8086
            <% if p('auth.github.enabled') %>
            - name: GF_AUTH_GITHUB_ENABLED
              value: "true"
            - name: GF_AUTH_GITHUB_ALLOW_SIGN_UP
              value: "<%= p('auth.github.allow_sign_up') %>"
            - name: GF_AUTH_GITHUB_CLIENT_ID
              value: <%= p('auth.github.client_id') %>
            - name: GF_AUTH_GITHUB_CLIENT_SECRET
              value: <%= p('auth.github.client_secret') %>
            - name: GF_AUTH_GITHUB_SCOPES
              value: "user:email,read:org"
            - name: GF_AUTH_GITHUB_AUTH_URL
              value: <%= p('auth.github.auth_url') %>
            - name: GF_AUTH_GITHUB_TOKEN_URL
              value: <%= p('auth.github.token_url') %>
            - name: GF_AUTH_GITHUB_API_URL
              value: <%= p('auth.github.api_url') %>
            - name: GF_AUTH_GITHUB_TEAM_IDS
              value: <%= p('auth.github.team_ids').join(',') %>
            - name: GF_AUTH_GITHUB_ALLOWED_DOMAINS
              value: <%= p('auth.github.allowed_email_domains').join(' ') %>
            - name: GF_AUTH_GITHUB_ALLOWED_ORGANIZATIONS
              value: <%= p('auth.github.allowed_organizations').join(' ') %>
            <% end %>
          volumeMounts:
          - name: grafana-persistent-storage
            mountPath: /var
      volumes:
      - name: influxdb-persistent-storage
        emptyDir: {}
      - name: grafana-persistent-storage
        emptyDir: {}
